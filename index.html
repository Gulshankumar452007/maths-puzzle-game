<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Puzzle Game</title>
    <style>
        /* Previous styles omitted for brevity */

        #puzzle-history-container {
        #challenge-levels-container {
            margin-top: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 350px;
            display: none;
        }

        #puzzle-history {
        #challenge-levels {
            height: 150px;
            overflow-y: auto;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
        }

        .history-item {
        .challenge-item {
            margin-bottom: 5px;
            padding: 5px;
            background-color: #fff;
            border-radius: 5px;
            cursor: pointer;
        }

        .history-item:hover {
        .challenge-item:hover {
            background-color: #e0e0e0;
        }

        #replay-button {
            margin-top: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }

        #replay-button:hover {
            background-color: #45a049;
        }

    </style>
</head>
<body data-theme="light">
    <header>
        <h1>Welcome to the Math Puzzle Game!</h1>
    </header>
    <main>
        <div id="game-container">
            <div id="mode-selection">
                <button id="classic-mode">Classic Mode</button>
                <button id="timed-mode">Timed Challenges</button>
                <button id="survival-mode">Survival Mode</button>
                <button id="puzzle-rush-mode">Puzzle Rush</button>
                <button id="multiplayer-mode">Multiplayer Mode</button>
                <button id="daily-challenge-mode">Daily Challenge</button>
            </div>
            <div id="puzzle">
                <!-- Puzzle will be dynamically generated here -->
            </div>
            <div id="hint">
                <!-- Hint will be displayed here -->
            </div>
            <div id="controls">
                <select id="difficulty">
                    <option value="easy">Easy</option>
                    <option value="medium" selected>Medium</option>
                    <option value="hard">Hard</option>
                    <option value="adaptive">Adaptive</option>
                </select>
                <input type="number" id="answer" placeholder="Your answer">
                <button id="submit-answer">Submit Answer</button>
                <button id="get-hint">Get Hint (-1 Point)</button>
                <button id="new-puzzle">New Puzzle</button>
                <button id="reset">Reset Game</button>
                <button id="dark-mode-toggle">Toggle Dark Mode</button>
                <button id="sound-toggle">Toggle Sound</button>
                <button id="music-toggle">Toggle Music</button>
                <button id="settings-toggle">Settings</button>
                <button id="tutorial-toggle">Show Tutorial</button>
                <div id="feedback"></div>
                <div id="score">Score: 0</div>
                <div id="high-score">High Score: 0</div>
                <div id="streak">Streak: 0</div>
                <div id="timer">Time Left: 30s</div>
                <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
                <div id="leaderboard">
                    <h2>Leaderboard</h2>
                    <ol id="leaderboard-list">
                        <!-- Top scores will be displayed here -->
                    </ol>
                </div>
                <div id="achievements">
                    <h2>Achievements</h2>
                    <ul id="achievement-list">
                        <!-- Achievements will be displayed here -->
                    </ul>
                </div>
                <div id="puzzle-history-container">
                    <h3>Puzzle History</h3>
                    <div id="puzzle-history">
                        <!-- Solved puzzles will be listed here -->
                    </div>
                    <button id="replay-button">Replay Selected Puzzle</button>
                </div>
                <div id="challenge-levels-container">
                    <h3>Challenge Levels</h3>
                    <div id="challenge-levels">
                        <!-- Unlocked challenge levels will be listed here -->
                    </div>
                </div>
                <div id="settings-menu">
                    <label for="background-color">Background Color:</label>
                    <input type="color" id="background-color">
                    <label for="text-color">Text Color:</label>
                    <input type="color" id="text-color">
                    <label for="button-color">Button Color:</label>
                    <input type="color" id="button-color">
                    <label for="sound-volume">Sound Volume:</label>
                    <input type="range" id="sound-volume" min="0" max="100">
                    <label for="music-volume">Music Volume:</label>
                    <input type="range" id="music-volume" min="0" max="100">
                    <button id="close-settings">Close Settings</button>
                </div>
                <div id="theme-selection">
                    <label for="theme">Choose Theme:</label>
                    <select id="theme">
                        <option value="light" selected>Light</option>
                        <option value="dark">Dark</option>
                        <option value="blue">Blue</option>
                        <option value="high-contrast">High Contrast</option>
                    </select>
                </div>
                <div id="accessibility-options">
                    <label for="large-text">Large Text</label>
                    <input type="checkbox" id="large-text">
                    <label for="high-contrast-mode">High Contrast Mode</label>
                    <input type="checkbox" id="high-contrast-mode">
                </div>
                <div id="advanced-stats">
                    <h2>Advanced Statistics</h2>
                    <ul>
                        <li>Total Puzzles Solved: <span id="total-puzzles">0</span></li>
                        <li>Correct Answers: <span id="correct-answers">0</span></li>
                        <li>Incorrect Answers: <span id="incorrect-answers">0</span></li>
                        <li>Accuracy: <span id="accuracy">0%</span></li>
                        <li>Average Response Time: <span id="average-time">0s</span></li>
                    </ul>
                </div>
                <div id="tutorial">
                    <h2>Game Tutorial</h2>
                    <p>Welcome to the Math Puzzle Game! Follow these steps to get started:</p>
                    <ol>
                        <li>Select a game mode from the options above.</li>
                        <li>Choose your difficulty level from the dropdown menu.</li>
                        <li>Solve the puzzle displayed and enter your answer in the box.</li>
                        <li>Click "Submit Answer" to check your answer.</li>
                        <li>Use the "Get Hint" button if you need help, but it will cost you points!</li>
                        <li>Keep an eye on the timer and try to score as high as possible.</li>
                    </ol>
                    <button id="close-tutorial">Close Tutorial</button>
                </div>
                <div id="tips">
                    <!-- Tips will be displayed here -->
                </div>
                <div id="end-summary">
                    <h2>Game Summary</h2>
                    <ul>
                        <li>Final Score: <span id="final-score">0</span></li>
                        <li>High Score: <span id="summary-high-score">0</span></li>
                        <li>Correct Answers: <span id="summary-correct-answers">0</span></li>
                        <li>Incorrect Answers: <span id="summary-incorrect-answers">0</span></li>
                        <li>Accuracy: <span id="summary-accuracy">0%</span></li>
                        <li>Average Response Time: <span id="summary-average-time">0s</span></li>
                        <li>Achievements Unlocked: <span id="summary-achievements">0</span></li>
                    </ul>
                    <div id="share-buttons">
                        <button class="share-button" id="share-twitter">Share on Twitter</button>
                        <button class="share-button fb" id="share-facebook">Share on Facebook</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <audio id="correct-sound" src="https://www.soundjay.com/button/beep-07.wav"></audio>
    <audio id="incorrect-sound" src="https://www.soundjay.com/button/beep-10.wav"></audio>
    <audio id="background-music" src="https://www.bensound.com/bensound-music/bensound-dreams.mp3" loop></audio>
    <script>
        let currentAnswer;
        let currentPuzzle;
        let currentOperator;
        let score = 0;
        let highScore = 0;
        let streak = 0;
        let timeLeft;
        let timerInterval;
        let totalPuzzles = JSON.parse(localStorage.getItem('totalPuzzles')) || 0;
        let correctAnswers = JSON.parse(localStorage.getItem('correctAnswers')) || 0;
        let incorrectAnswers = JSON.parse(localStorage.getItem('incorrectAnswers')) || 0;
        let totalResponseTime = JSON.parse(localStorage.getItem('totalResponseTime')) || 0;
        let responseStartTime;
        let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
        let timedLeaderboard = JSON.parse(localStorage.getItem('timedLeaderboard')) || [];
        let dailyLeaderboard = JSON.parse(localStorage.getItem('dailyLeaderboard')) || [];
        let achievements = JSON.parse(localStorage.getItem('achievements')) || [];
        let dailyAchievements = JSON.parse(localStorage.getItem('dailyAchievements')) || [];
        let theme = localStorage.getItem('theme') || 'light';
        let soundEnabled = JSON.parse(localStorage.getItem('soundEnabled')) || true;
        let musicEnabled = JSON.parse(localStorage.getItem('musicEnabled')) || false;
        let soundVolume = JSON.parse(localStorage.getItem('soundVolume')) || 50;
        let musicVolume = JSON.parse(localStorage.getItem('musicVolume')) || 50;
        let backgroundColor = localStorage.getItem('backgroundColor') || '#f4f4f4';
        let textColor = localStorage.getItem('textColor') || '#333';
        let buttonColor = localStorage.getItem('buttonColor') || '#4CAF50';
        let largeText = JSON.parse(localStorage.getItem('largeText')) || false;
        let highContrastMode = JSON.parse(localStorage.getItem('highContrastMode')) || false;
        let mode = 'classic';
        let playerTurn = 1;
        let playerScores = [0, 0];
        let powerUpActive = null;
        let opponentFrozen = false;
        let dailyChallengeCompleted = JSON.parse(localStorage.getItem('dailyChallengeCompleted')) || false;
        let dailyChallengeDate = localStorage.getItem('dailyChallengeDate') || '';
        let gameHistory = JSON.parse(localStorage.getItem('gameHistory')) || [];
        let tips = [
            "Remember, practice makes perfect!",
            "Use the hints wisely—they cost points!",
            "Try different difficulty levels to challenge yourself.",
            "Multiplayer mode is more fun with friends!",
            "Keep track of your progress in the statistics section."
        ];
        let puzzleHistory = [];
        let selectedPuzzle = null;
        let challengeLevels = [];
        let tutorialVisible = false;

        const achievementList = [
            { id: 1, name: 'Score 50 Points on Easy', achieved: false, difficulty: 'easy', check: () => score >= 50 && document.getElementById('difficulty').value === 'easy' },
            { id: 2, name: 'High Streak of 10 on Easy', achieved: false, difficulty: 'easy', check: () => streak >= 10 && document.getElementById('difficulty').value === 'easy' },
            { id: 3, name: 'Score 50 Points on Medium', achieved: false, difficulty: 'medium', check: () => score >= 50 && document.getElementById('difficulty').value === 'medium' },
            { id: 4, name: 'High Streak of 10 on Medium', achieved: false, difficulty: 'medium', check: () => streak >= 10 && document.getElementById('difficulty').value === 'medium' },
            { id: 5, name: 'Score 50 Points on Hard', achieved: false, difficulty: 'hard', check: () => score >= 50 && document.getElementById('difficulty').value === 'hard' },
            { id: 6, name: 'High Streak of 10 on Hard', achieved: false, difficulty: 'hard', check: () => streak >= 10 && document.getElementById('difficulty').value === 'hard' },
            { id: 7, name: 'Finish a Game Without Hints on Any Difficulty', achieved: false, check: () => streak > 0 && score > 0 && !hintUsedThisGame },
            { id: 8, name: 'Score 100 Points in Timed Challenges', achieved: false, check: () => score >= 100 && mode === 'timed' },
            { id: 9, name: 'Solve 10 Puzzles in Timed Challenges', achieved: false, check: () => streak >= 10 && mode === 'timed' }
        ];
        const dailyAchievementList = [
            { id: 1, name: 'Complete 1 Daily Challenge', achieved: false, check: () => dailyChallengeCompleted },
            { id: 2, name: 'Complete 5 Daily Challenges', achieved: false, check: () => dailyAchievements.length >= 5 },
            { id: 3, name: 'Complete 10 Daily Challenges', achieved: false, check: () => dailyAchievements.length >= 10 },
            { id: 4, name: 'Complete a Daily Challenge Streak of 7 Days', achieved: false, check: () => checkDailyChallengeStreak(7) },
            { id: 5, name: 'Complete a Daily Challenge Streak of 30 Days', achieved: false, check: () => checkDailyChallengeStreak(30) }
        ];
        let hintUsedThisGame = false;

        function setInitialTime() {
            if (mode === 'classic') {
            if (mode === 'classic' || mode === 'adaptive') {
                const difficulty = document.getElementById('difficulty').value;
                if (difficulty === 'easy') {
                    timeLeft = 45;
                } else if (difficulty === 'medium') {
                    timeLeft = 30;
                } else if (difficulty === 'hard') {
                    timeLeft = 20;
                } else if (difficulty === 'adaptive') {
                    timeLeft = adaptiveTimeBasedOnPerformance();
                }
            } else if (mode === 'timed') {
                timeLeft = 60;
            } else if (mode === 'daily') {
                timeLeft = 90; // Daily challenges have 90 seconds
            } else if (mode === 'survival') {
                timeLeft = 30; // Survival mode starts with 30 seconds
            } else if (mode === 'puzzle-rush') {
                timeLeft = 10; // Puzzle Rush mode starts with 10 seconds per puzzle
            } else if (mode === 'multiplayer') {
                timeLeft = 120; // Multiplayer mode has 2 minutes total for the game
            } else {
                timeLeft = 120;
            }
            document.getElementById('timer').textContent = `Time Left: ${timeLeft}s`;
            updateProgressBar();
        }

        function adaptiveTimeBasedOnPerformance() {
            // Adjust time based on player's accuracy and streak
            const accuracy = correctAnswers > 0 ? (correctAnswers / totalPuzzles) * 100 : 0;
            if (accuracy > 80 && streak >= 5) {
                return 20; // Make it harder
            } else if (accuracy > 50) {
                return 30; // Medium challenge
            } else {
                return 45; // Easy challenge
            }
        }

        function generatePuzzle() {
            const difficulty = document.getElementById('difficulty').value;
            let num1, num2;
            let min, max;
            if (difficulty === 'easy') {
                min = 1;
                max = 10;
            } else if (difficulty === 'medium') {
                min = 10;
                max = 50;
            } else {
            } else if (difficulty === 'hard') {
                min = 50;
                max = 100;
            } else if (difficulty === 'adaptive') {
                ({ min, max } = adaptiveDifficultyBasedOnPerformance());
            }

            num1 = Math.floor(Math.random() * (max - min + 1)) + min;
            num2 = Math.floor(Math.random() * (max - min + 1)) + min;
            const operations = ['+', '-', '*', '/'];
            currentOperator = operations[Math.floor(Math.random() * operations.length)];
            if (currentOperator === '+') {
                currentAnswer = num1 + num2;
            } else if (currentOperator === '-') {
                currentAnswer = num1 - num2;
            } else if (currentOperator === '*') {
                currentAnswer = num1 * num2;
            } else if (currentOperator === '/') {
                currentAnswer = num1;
                num1 = currentAnswer * num2;
            }
            currentPuzzle = { num1, num2, operator: currentOperator, answer: currentAnswer };
            document.getElementById('puzzle').textContent = `What is ${num1} ${currentOperator} ${num2}?`;
            document.getElementById('hint').textContent = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('answer').value = '';
            responseStartTime = Date.now();
            // Add puzzle to history
            addToPuzzleHistory(currentPuzzle);
        }

        function adaptiveDifficultyBasedOnPerformance() {
            const accuracy = correctAnswers > 0 ? (correctAnswers / totalPuzzles) * 100 : 0;
            if (accuracy > 80 && streak >= 5) {
                return { min: 50, max: 100 }; // Make it harder
            } else if (accuracy > 50) {
                return { min: 10, max: 50 }; // Medium challenge
            } else {
                return { min: 1, max: 10 }; // Easy challenge
            }
        }

        function provideHint() {
            let hintMessage = '';
            if (score > 0) {
                score--;
                hintUsedThisGame = true;
                updateScore();
                if (currentOperator === '+' || currentOperator === '-') {
                    hintMessage = `One of the numbers is ${currentPuzzle.num1}.`;
                } else if (currentOperator === '*') {
                    hintMessage = `The result is divisible by ${currentPuzzle.num1}.`;
                } else if (currentOperator === '/') {
                    hintMessage = `After division, the result is ${currentAnswer}.`;
                }
                document.getElementById('hint').textContent = hintMessage;
            } else {
                document.getElementById('hint').textContent = 'Not enough points for a hint!';
            }
        }
        function checkAnswer() {
            const userAnswer = parseInt(document.getElementById('answer').value);
            const feedbackElement = document.getElementById('feedback');
            const correctSound = document.getElementById('correct-sound');
            const incorrectSound = document.getElementById('incorrect-sound');
            const responseTime = (Date.now() - responseStartTime) / 1000;
            if (userAnswer === currentAnswer) {
                let pointsGained = 2 + getBonusPoints();
                if (powerUpActive === 'double-points') {
                    pointsGained *= 2;
                    powerUpActive = null;
                }
                feedbackElement.textContent = `Correct! +${pointsGained} points!`;
                feedbackElement.classList.add('correct');
                feedbackElement.classList.remove('incorrect');
                streak++;
                score += pointsGained;
                correctAnswers++;
                totalPuzzles++;
                totalResponseTime += responseTime;
                if (mode === 'survival') {
                    timeLeft += 5; // Add 5 seconds for each correct answer in Survival Mode
                }
                if (soundEnabled) {
                    correctSound.volume = soundVolume / 100;
                    correctSound.play();
                }
                updateScore();
                updateStreak();
                updateStatistics();
                checkAchievements();
                generatePuzzle();
                if (mode === 'multiplayer') {
                    playerScores[playerTurn - 1] += pointsGained;
                    updatePlayerScores();
                    if (!opponentFrozen) {
                        switchTurn();
                    } else {
                        opponentFrozen = false; // Opponent is unfrozen after one turn
                    }
                }
            } else {
                feedbackElement.textContent = 'Incorrect. Streak reset!';
                feedbackElement.classList.add('incorrect');
                feedbackElement.classList.remove('correct');
                streak = 0;
                incorrectAnswers++;
                totalPuzzles++;
                if (soundEnabled) {
                    incorrectSound.volume = soundVolume / 100;
                    incorrectSound.play();
                }
                updateStreak();
                updateStatistics();
                if (mode === 'multiplayer') {
                    switchTurn();
                }
            }
            localStorage.setItem('totalPuzzles', JSON.stringify(totalPuzzles));
            localStorage.setItem('correctAnswers', JSON.stringify(correctAnswers));
            localStorage.setItem('incorrectAnswers', JSON.stringify(incorrectAnswers));
            localStorage.setItem('totalResponseTime', JSON.stringify(totalResponseTime));
            if (mode === 'puzzle-rush' && timeLeft <= 0) {
                endGame();
            }
        }
        function getBonusPoints() {
            return streak >= 3 ? Math.floor(streak / 3) : 0;
        }
        function updateScore() {
            document.getElementById('score').textContent = `Score: ${score}`;
            if (mode === 'classic' && score > highScore) {
                highScore = score;
                document.getElementById('high-score').textContent = `High Score: ${highScore}`;
            } else if (mode === 'timed' && score > highScore) {
                highScore = score;
                document.getElementById('high-score').textContent = `High Score: ${highScore}`;
            } else if (mode === 'daily' && score > highScore) {
                highScore = score;
                document.getElementById('high-score').textContent = `High Score: ${highScore}`;
            }
        }
        function updateStreak() {
            document.getElementById('streak').textContent = `Streak: ${streak}`;
        }
        function updatePlayerScores() {
            document.getElementById('player-scores').textContent = `Player 1: ${playerScores[0]} | Player 2: ${playerScores[1]}`;
        }
        function updateTimer() {
            timeLeft--;
            document.getElementById('timer').textContent = `Time Left: ${timeLeft}s`;
            updateProgressBar();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                endGame();
            }
        }

        function updateProgressBar() {
            const initialTime = mode === 'classic' ?
            const initialTime = mode === 'classic' || mode === 'adaptive' ?
                (document.getElementById('difficulty').value === 'easy' ? 45 :
                    document.getElementById('difficulty').value === 'medium' ? 30 : 20) :
                    document.getElementById('difficulty').value === 'medium' ? 30 : document.getElementById('difficulty').value === 'adaptive' ? adaptiveTimeBasedOnPerformance() : 20) :
                (mode === 'timed' ? 60 : mode === 'daily' ? 90 : mode === 'survival' ? 30 : 10);
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${(timeLeft / initialTime) * 100}%`;
        }
        function startTimer() {
            timerInterval = setInterval(updateTimer, 1000);
        }
        function endGame() {
            let endMessage = `Game Over! Your final score is ${score}.`;
            if (mode === 'multiplayer') {
                if (playerScores[0] > playerScores[1]) {
                    endMessage = `Game Over! Player 1 wins with ${playerScores[0]} points!`;
                } else if (playerScores[1] > playerScores[0]) {
                    endMessage = `Game Over! Player 2 wins with ${playerScores[1]} points!`;
                } else {
                    endMessage = `Game Over! It's a tie at ${playerScores[0]} points each!`;
                }
            } else if (mode === 'daily') {
                endMessage = `Daily Challenge Complete! Your final score is ${score}.`;
                dailyChallengeCompleted = true;
                localStorage.setItem('dailyChallengeCompleted', JSON.stringify(dailyChallengeCompleted));
                updateDailyLeaderboard();
                checkDailyAchievements();
            } else if (mode === 'survival') {
                endMessage = `Survival Mode Over! Your final score is ${score}.`;
            } else if (mode === 'puzzle-rush') {
                endMessage = `Puzzle Rush Over! Your final score is ${score}.`;
            }
            document.getElementById('feedback').textContent = endMessage;
            document.getElementById('feedback').classList.remove('correct', 'incorrect');
            document.getElementById('puzzle').textContent = '';
            document.getElementById('hint').textContent = '';
            document.getElementById('submit-answer').disabled = true;
            document.getElementById('new-puzzle').disabled = true;
            document.getElementById('get-hint').disabled = true;
            document.getElementById('chat-container').style.display = 'none';
            document.getElementById('power-ups-container').style.display = 'none';
            updateLeaderboard();
            checkAchievements();
            saveGameHistory();
            hintUsedThisGame = false;
            displayEndSummary();
        }
        function resetGame() {
            score = 0;
            streak = 0;
            playerScores = [0, 0];
            playerTurn = 1;
            opponentFrozen = false;
            powerUpActive = null;
            setInitialTime();
            updateScore();
            updateStreak();
            updatePlayerScores();
            document.getElementById('player-turn').textContent = `Player 1's Turn`;
            document.getElementById('submit-answer').disabled = false;
            document.getElementById('new-puzzle').disabled = false;
            document.getElementById('get-hint').disabled = false;
            clearInterval(timerInterval);
            startTimer();
            generatePuzzle();
            displayRandomTip();
        }
        function updateLeaderboard() {
            if (mode === 'classic') {
                leaderboard.push(score);
                leaderboard.sort((a, b) => b - a);
                leaderboard = leaderboard.slice(0, 5);
                localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
                displayLeaderboard(leaderboard);
            } else if (mode === 'timed') {
                timedLeaderboard.push(score);
                timedLeaderboard.sort((a, b) => b - a);
                timedLeaderboard = timedLeaderboard.slice(0, 5);
                localStorage.setItem('timedLeaderboard', JSON.stringify(timedLeaderboard));
                displayLeaderboard(timedLeaderboard);
            } else if (mode === 'daily') {
                dailyLeaderboard.push(score);
                dailyLeaderboard.sort((a, b) => b - a);
                dailyLeaderboard = dailyLeaderboard.slice(0, 5);
                localStorage.setItem('dailyLeaderboard', JSON.stringify(dailyLeaderboard));
                displayLeaderboard(dailyLeaderboard);
            } else if (mode === 'survival') {
                leaderboard.push(score);
                leaderboard.sort((a, b) => b - a);
                leaderboard = leaderboard.slice(0, 5);
                localStorage.setItem('survivalLeaderboard', JSON.stringify(leaderboard));
                displayLeaderboard(leaderboard);
            } else if (mode === 'puzzle-rush') {
                leaderboard.push(score);
                leaderboard.sort((a, b) => b - a);
                leaderboard = leaderboard.slice(0, 5);
                localStorage.setItem('puzzleRushLeaderboard', JSON.stringify(leaderboard));
                displayLeaderboard(leaderboard);
            }
        }
        function updateDailyLeaderboard() {
            dailyLeaderboard.push(score);
            dailyLeaderboard.sort((a, b) => b - a);
            dailyLeaderboard = dailyLeaderboard.slice(0, 5);
            localStorage.setItem('dailyLeaderboard', JSON.stringify(dailyLeaderboard));
            displayLeaderboard(dailyLeaderboard);
        }
        function displayLeaderboard(leaderboardArray) {
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';
            leaderboardArray.forEach((score, index) => {
                const listItem = document.createElement('li');
                listItem.textContent = `#${index + 1}: ${score} points`;
                leaderboardList.appendChild(listItem);
            });
        }
        function checkAchievements() {
            achievementList.forEach(achievement => {
                if (!achievement.achieved && achievement.check()) {
                    achievement.achieved = true;
                    achievements.push(achievement);
                    localStorage.setItem('achievements', JSON.stringify(achievements));
                }
            });
            displayAchievements();
        }
        function checkDailyAchievements() {
            dailyAchievementList.forEach(achievement => {
                if (!achievement.achieved && achievement.check()) {
                    achievement.achieved = true;
                    dailyAchievements.push(achievement);
                    localStorage.setItem('dailyAchievements', JSON.stringify(dailyAchievements));
                }
            });
            displayDailyAchievements();
        }
        function displayAchievements() {
            const achievementListElement = document.getElementById('achievement-list');
            achievementListElement.innerHTML = '';
            achievements.forEach(achievement => {
                const listItem = document.createElement('li');
                listItem.textContent = `🏆 ${achievement.name}`;
                achievementListElement.appendChild(listItem);
            });
        }
        function displayDailyAchievements() {
            const dailyAchievementListElement = document.getElementById('daily-challenge-achievement-list');
            dailyAchievementListElement.innerHTML = '';
            dailyAchievements.forEach(achievement => {
                const listItem = document.createElement('li');
                listItem.textContent = `🏆 ${achievement.name}`;
                dailyAchievementListElement.appendChild(listItem);
            });
        }
        function updateStatistics() {
            const accuracy = correctAnswers > 0 ? ((correctAnswers / totalPuzzles) * 100).toFixed(2) : 0;
            const averageTime = totalPuzzles > 0 ? (totalResponseTime / totalPuzzles).toFixed(2) : 0;
            document.getElementById('total-puzzles').textContent = totalPuzzles;
            document.getElementById('correct-answers').textContent = correctAnswers;
            document.getElementById('incorrect-answers').textContent = incorrectAnswers;
            document.getElementById('accuracy').textContent = `${accuracy}%`;
            document.getElementById('average-time').textContent = `${averageTime}s`;
        }
        function toggleDarkMode() {
            const newTheme = theme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            theme = newTheme;
        }
        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('soundEnabled', JSON.stringify(soundEnabled));
        }
        function toggleMusic() {
            musicEnabled = !musicEnabled;
            const backgroundMusic = document.getElementById('background-music');
            if (musicEnabled) {
                backgroundMusic.volume = musicVolume / 100;
                backgroundMusic.play();
            } else {
                backgroundMusic.pause();
            }
            localStorage.setItem('musicEnabled', JSON.stringify(musicEnabled));
        }
        function switchMode(selectedMode) {
            mode = selectedMode;
            resetGame();
            if (selectedMode === 'daily') {
                startDailyChallenge();
            }
        }
        function switchTurn() {
            playerTurn = playerTurn === 1 ? 2 : 1;
            document.getElementById('player-turn').textContent = `Player ${playerTurn}'s Turn`;
        }
        function activatePowerUp(powerUp) {
            if (powerUp === 'double-points') {
                powerUpActive = 'double-points';
                document.getElementById('double-points').disabled = true;
            } else if (powerUp === 'freeze-opponent') {
                opponentFrozen = true;
                switchTurn();
                document.getElementById('freeze-opponent').disabled = true;
            } else if (powerUp === 'extra-time') {
                timeLeft += 10;
                updateTimer();
                document.getElementById('extra-time').disabled = true;
            }
        }
        function openSettings() {
            document.getElementById('settings-menu').style.display = 'flex';
        }
        function closeSettings() {
            document.getElementById('settings-menu').style.display = 'none';
        }
        function applySettings() {
            const backgroundColorPicker = document.getElementById('background-color');
            const textColorPicker = document.getElementById('text-color');
            const buttonColorPicker = document.getElementById('button-color');
            const soundVolumeSlider = document.getElementById('sound-volume');
            const musicVolumeSlider = document.getElementById('music-volume');
            backgroundColor = backgroundColorPicker.value;
            textColor = textColorPicker.value;
            buttonColor = buttonColorPicker.value;
            soundVolume = soundVolumeSlider.value;
            musicVolume = musicVolumeSlider.value;
            document.documentElement.style.setProperty('--default-background', backgroundColor);
            document.documentElement.style.setProperty('--default-text', textColor);
            document.documentElement.style.setProperty('--button-background', buttonColor);
            document.getElementById('background-music').volume = musicVolume / 100;
            localStorage.setItem('backgroundColor', backgroundColor);
            localStorage.setItem('textColor', textColor);
            localStorage.setItem('buttonColor', buttonColor);
            localStorage.setItem('soundVolume', JSON.stringify(soundVolume));
            localStorage.setItem('musicVolume', JSON.stringify(musicVolume));
        }
        function startDailyChallenge() {
            const today = new Date().toISOString().split('T')[0];
            if (dailyChallengeDate !== today) {
                dailyChallengeDate = today;
                dailyChallengeCompleted = false;
                localStorage.setItem('dailyChallengeDate', dailyChallengeDate);
                localStorage.setItem('dailyChallengeCompleted', JSON.stringify(dailyChallengeCompleted));
                resetGame();
                updateDailyStats();
            }
        }
        function updateDailyStats() {
            const dailyChallengeStats = document.getElementById('daily-challenge-stats');
            dailyChallengeStats.textContent = `Today's Challenge Date: ${dailyChallengeDate}`;
            displayDailyAchievements();
        }
        function checkDailyChallengeStreak(days) {
            const today = new Date();
            const dates = dailyAchievements.map(achievement => new Date(achievement.date));
            dates.sort((a, b) => b - a);
            const streak = dates.reduce((acc, date, index, arr) => {
                if (index === 0) return 1;
                const diff = (arr[index - 1] - date) / (1000 * 60 * 60 * 24);
                return diff === 1 ? acc + 1 : acc;
            }, 1);
            return streak >= days;
        }
        function saveGameHistory() {
            const today = new Date().toISOString().split('T')[0];
            gameHistory.push({ date: today, score: score, mode: mode });
            localStorage.setItem('gameHistory', JSON.stringify(gameHistory));
            displayGameHistory();
        }
        function displayGameHistory() {
            const gameHistoryList = document.getElementById('game-history-list');
            gameHistoryList.innerHTML = '';
            gameHistory.forEach(game => {
                const listItem = document.createElement('li');
                listItem.textContent = `Date: ${game.date}, Mode: ${game.mode}, Score: ${game.score}`;
                gameHistoryList.appendChild(listItem);
            });
        }
        function addToPuzzleHistory(puzzle) {
            puzzleHistory.push(puzzle);
            displayPuzzleHistory();
        }
        function displayPuzzleHistory() {
            const puzzleHistoryContainer = document.getElementById('puzzle-history-container');
            puzzleHistoryContainer.style.display = 'block';
            const puzzleHistoryList = document.getElementById('puzzle-history');
            puzzleHistoryList.innerHTML = '';
            puzzleHistory.forEach((puzzle, index) => {
                const listItem = document.createElement('div');
                listItem.classList.add('history-item');
                listItem.textContent = `Puzzle ${index + 1}: ${puzzle.num1} ${puzzle.operator} ${puzzle.num2}`;
                listItem.addEventListener('click', () => selectPuzzle(index));
                puzzleHistoryList.appendChild(listItem);
            });
        }
        function selectPuzzle(index) {
            selectedPuzzle = puzzleHistory[index];
            const replayButton = document.getElementById('replay-button');
            replayButton.disabled = false;
            replayButton.addEventListener('click', replaySelectedPuzzle);
        }
        function replaySelectedPuzzle() {
            if (selectedPuzzle) {
                document.getElementById('puzzle').textContent = `What is ${selectedPuzzle.num1} ${selectedPuzzle.operator} ${selectedPuzzle.num2}?`;
                currentAnswer = selectedPuzzle.answer;
                document.getElementById('feedback').textContent = '';
                document.getElementById('answer').value = '';
                responseStartTime = Date.now();
            }
        }

        function unlockChallengeLevel(levelName, criteria) {
            if (!challengeLevels.includes(levelName) && criteria()) {
                challengeLevels.push(levelName);
                displayChallengeLevels();
            }
        }

        function displayChallengeLevels() {
            const challengeLevelsContainer = document.getElementById('challenge-levels-container');
            challengeLevelsContainer.style.display = 'block';
            const challengeLevelsList = document.getElementById('challenge-levels');
            challengeLevelsList.innerHTML = '';
            challengeLevels.forEach(level => {
                const listItem = document.createElement('div');
                listItem.classList.add('challenge-item');
                listItem.textContent = `🔓 ${level}`;
                challengeLevelsList.appendChild(listItem);
            });
        }

        function checkChallengeLevelUnlocks() {
            unlockChallengeLevel('Master of Medium', () => score >= 100 && document.getElementById('difficulty').value === 'medium');
            unlockChallengeLevel('Survival Expert', () => mode === 'survival' && score >= 50);
            unlockChallengeLevel('Puzzle Rush Master', () => mode === 'puzzle-rush' && score >= 30);
        }

        function displayTutorial() {
            const tutorialElement = document.getElementById('tutorial');
            tutorialVisible = !tutorialVisible;
            tutorialElement.style.display = tutorialVisible ? 'block' : 'none';
        }
        function displayRandomTip() {
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            document.getElementById('tips').textContent = `Tip: ${randomTip}`;
        }
        function displayEndSummary() {
            document.getElementById('final-score').textContent = score;
            document.getElementById('summary-high-score').textContent = highScore;
            document.getElementById('summary-correct-answers').textContent = correctAnswers;
            document.getElementById('summary-incorrect-answers').textContent = incorrectAnswers;
            document.getElementById('summary-accuracy').textContent = `${((correctAnswers / totalPuzzles) * 100).toFixed(2)}%`;
            document.getElementById('summary-average-time').textContent = `${(totalResponseTime / totalPuzzles).toFixed(2)}s`;
            document.getElementById('summary-achievements').textContent = achievements.filter(a => a.achieved).length;
            document.getElementById('end-summary').style.display = 'block';
        }
        function shareOnTwitter() {
            const text = `I scored ${score} in the Math Puzzle Game! Can you beat my score?`;
            const url = encodeURIComponent(window.location.href);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        }
        function shareOnFacebook() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
        }
        document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);
        document.getElementById('sound-toggle').addEventListener('click', toggleSound);
        document.getElementById('music-toggle').addEventListener('click', toggleMusic);
        document.getElementById('new-puzzle').addEventListener('click', generatePuzzle);
        document.getElementById('submit-answer').addEventListener('click', checkAnswer);
        document.getElementById('get-hint').addEventListener('click', provideHint);
        document.getElementById('reset').addEventListener('click', resetGame);
        document.getElementById('difficulty').addEventListener('change', resetGame);
        document.getElementById('classic-mode').addEventListener('click', () => switchMode('classic'));
        document.getElementById('timed-mode').addEventListener('click', () => switchMode('timed'));
        document.getElementById('survival-mode').addEventListener('click', () => switchMode('survival'));
        document.getElementById('puzzle-rush-mode').addEventListener('click', () => switchMode('puzzle-rush'));
        document.getElementById('multiplayer-mode').addEventListener('click', () => switchMode('multiplayer'));
        document.getElementById('daily-challenge-mode').addEventListener('click', () => switchMode('daily'));
        document.getElementById('settings-toggle').addEventListener('click', openSettings);
        document.getElementById('close-settings').addEventListener('click', () => {
            applySettings();
            closeSettings();
        });
        document.getElementById('theme').addEventListener('change', applyTheme);
        document.getElementById('large-text').addEventListener('change', applyAccessibilityOptions);
        document.getElementById('high-contrast-mode').addEventListener('change', applyAccessibilityOptions);
        document.getElementById('tutorial-toggle').addEventListener('click', displayTutorial);
        document.getElementById('close-tutorial').addEventListener('click', displayTutorial);
        document.getElementById('share-twitter').addEventListener('click', shareOnTwitter);
        document.getElementById('share-facebook').addEventListener('click', shareOnFacebook);
        // Initialize the game on page load
        window.onload = () => {
            document.body.setAttribute('data-theme', theme);
            const backgroundMusic = document.getElementById('background-music');
            if (musicEnabled) {
                backgroundMusic.volume = musicVolume / 100;
                backgroundMusic.play();
            }
            document.documentElement.style.setProperty('--default-background', backgroundColor);
            document.documentElement.style.setProperty('--default-text', textColor);
            document.documentElement.style.setProperty('--button-background', buttonColor);
            if (largeText) {
                document.body.style.fontSize = '20px';
            }
            if (highContrastMode) {
                document.body.setAttribute('data-theme', 'high-contrast');
            }
            resetGame();
            displayLeaderboard(leaderboard);
            displayAchievements();
            startDailyChallenge();
            updateDailyStats();
            displayGameHistory();
            updateStatistics();
            checkChallengeLevelUnlocks();
        };
    </script>
</body>
</html>
